"use client";
import React, { useMemo, useState } from "react";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Slider } from "@/components/ui/slider";
import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription, SheetFooter } from "@/components/ui/sheet";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Checkbox } from "@/components/ui/checkbox";
import { Download, Filter, SlidersHorizontal, Sparkles, Search, Info } from "lucide-react";

// --------------------------
// Sample seed data (replace with API later)
// --------------------------

export type Capability = {
  id: string;
  name: string; // e.g., "DTC > Commerce > Checkout"
  domain: string; // e.g., "DTC"
  description?: string;
  owner?: string;
  l1?: string;
  l2?: string;
  l3?: string;
  l4?: string;
  scores: Scores; // user-entered
};

type Scores = {
  maturity: number; // 1-5
  techFit: number; // 1-5
  strategicAlignment: number; // 1-5
  peopleReadiness: number; // 1-5
  opportunity: number; // 1-5
};

const DOMAINS = [
  "Consumer",
  "Data & Analytics",
  "Data Platform",
  "DTC",
  "Enterprise",
  "Security",
  "Finance",
  "Human Resources",
  "Marketing",
  "Omnichannel Sales",
  "Supply Chain",
] as const;

const seed: Capability[] = [
  {
    id: "cap-1",
    domain: "DTC",
    name: "DTC > Commerce > Checkout",
    l1: "Commerce",
    l2: "Checkout",
    description: "Customer-facing checkout flow including payments and tax.",
    scores: { maturity: 3, techFit: 2, strategicAlignment: 5, peopleReadiness: 3, opportunity: 5 },
  },
  {
    id: "cap-2",
    domain: "Supply Chain",
    name: "Supply Chain > Fulfillment > Order Orchestration",
    l1: "Fulfillment",
    l2: "Order Orchestration",
    description: "Sourcing and allocation across DCs and stores.",
    scores: { maturity: 2, techFit: 2, strategicAlignment: 4, peopleReadiness: 3, opportunity: 4 },
  },
  {
    id: "cap-3",
    domain: "Marketing",
    name: "Marketing > Lifecycle > Personalization",
    l1: "Lifecycle",
    l2: "Personalization",
    description: "Content and offer personalization across channels.",
    scores: { maturity: 2, techFit: 3, strategicAlignment: 5, peopleReadiness: 2, opportunity: 5 },
  },
  {
    id: "cap-4",
    domain: "Finance",
    name: "Finance > Planning > FP&A",
    l1: "Planning",
    l2: "FP&A",
    description: "Forecasting, budgeting, and performance management.",
    scores: { maturity: 3, techFit: 3, strategicAlignment: 4, peopleReadiness: 3, opportunity: 3 },
  },
  {
    id: "cap-5",
    domain: "Security",
    name: "Security > Identity & Access > IAM Governance",
    l1: "Identity & Access",
    l2: "IAM Governance",
    description: "Policy, provisioning, and access reviews.",
    scores: { maturity: 4, techFit: 4, strategicAlignment: 4, peopleReadiness: 3, opportunity: 2 },
  },
];

// --------------------------
// Helpers
// --------------------------

const defaultWeights = {
  opportunity: 0.30,
  maturity: 0.20,
  techFit: 0.20,
  strategicAlignment: 0.20,
  peopleReadiness: 0.10,
};

function clamp(v: number, min = 1, max = 5) { return Math.max(min, Math.min(max, v)); }

function compositeScore(s: Scores, w = defaultWeights) {
  // normalize (1..5) to (0..1) for weighting
  const n = (x: number) => (clamp(x) - 1) / 4;
  const score =
    n(s.opportunity) * w.opportunity +
    n(s.maturity) * w.maturity +
    n(s.techFit) * w.techFit +
    n(s.strategicAlignment) * w.strategicAlignment +
    n(s.peopleReadiness) * w.peopleReadiness;
  return Math.round(score * 100) / 100; // 0..1 two decimals
}

function heatColor(score01: number) {
  // 0..1 → Tailwind classes
  if (score01 >= 0.75) return "bg-green-100 border-green-300";
  if (score01 >= 0.5) return "bg-yellow-100 border-yellow-300";
  if (score01 >= 0.25) return "bg-orange-100 border-orange-300";
  return "bg-red-100 border-red-300";
}

function aiCoachTip(s: Scores): string {
  const tips: string[] = [];
  if (s.maturity <= 2 && s.opportunity >= 4) tips.push("Low maturity + high opportunity: consider near-term investment.");
  if (s.techFit <= 2) tips.push("Tech fit is low: review platform alignment and integration constraints.");
  if (s.peopleReadiness <= 2) tips.push("People readiness is low: plan enablement and change mgmt early.");
  if (s.strategicAlignment <= 2) tips.push("Strategic alignment weak: validate business outcomes and KPIs.");
  if (!tips.length) return "Looks balanced. Explore adjacent capabilities for compounding value.";
  return tips.join(" \n• ");
}

// --------------------------
// Main App
// --------------------------

export default function App() {
  const [data, setData] = useState<Capability[]>(seed);
  const [query, setQuery] = useState("");
  const [domain, setDomain] = useState<string>("All Domains");
  const [view, setView] = useState<"grid" | "heat">("grid");
  const [weights, setWeights] = useState(defaultWeights);

  const [active, setActive] = useState<Capability | null>(null);
  const [open, setOpen] = useState(false);

  const filtered = useMemo(() => {
    return data
      .filter((c) => (domain === "All Domains" ? true : c.domain === domain))
      .filter((c) => c.name.toLowerCase().includes(query.toLowerCase()));
  }, [data, domain, query]);

  const sorted = useMemo(() => {
    return [...filtered].sort((a, b) => compositeScore(b.scores, weights) - compositeScore(a.scores, weights));
  }, [filtered, weights]);

  function openScoring(c: Capability) {
    setActive(c);
    setOpen(true);
  }

  function updateScore(key: keyof Scores, value: number) {
    if (!active) return;
    const next = data.map((c) => (c.id === active.id ? { ...c, scores: { ...c.scores, [key]: value } } : c));
    setData(next);
    setActive({ ...active, scores: { ...active.scores, [key]: value } });
  }

  function exportJson() {
    const payload = data.map((c) => ({
      id: c.id,
      name: c.name,
      domain: c.domain,
      scores: c.scores,
      composite: compositeScore(c.scores, weights),
    }));
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "fuxi_capability_scoring_export.json";
    a.click();
    URL.revokeObjectURL(url);
  }
  return (
    <div className="min-h-screen w-full bg-white">
      {/* Top bar */}
      <div className="p-4 rounded-xl bg-blue-500 text-white">Tailwind is alive ✅</div>
      <div className="sticky top-0 z-10 border-b bg-white/80 backdrop-blur">
        <div className="mx-auto flex max-w-7xl items-center gap-3 px-4 py-3">
          <Sparkles className="h-5 w-5" />
          <div className="font-semibold">Fuxi • Capability Scoring</div>
          <div className="ml-auto flex items-center gap-2">
            <div className="relative">
              <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
              <Input
                className="pl-8 w-64"
                placeholder="Search capabilities…"
                value={query}
                onChange={(e) => setQuery(e.target.value)}
              />
            </div>

            <Select value={domain} onValueChange={setDomain}>
              <SelectTrigger className="w-[180px]">
                <SelectValue placeholder="Domain" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="All Domains">All Domains</SelectItem>
                {DOMAINS.map((d) => (
                  <SelectItem key={d} value={d}>{d}</SelectItem>
                ))}
              </SelectContent>
            </Select>

            <Tabs value={view} onValueChange={(v)=>setView(v as any)} className="">
              <TabsList>
                <TabsTrigger value="grid">Grid</TabsTrigger>
                <TabsTrigger value="heat">Heatmap</TabsTrigger>
              </TabsList>
            </Tabs>

            <Popover>
              <PopoverTrigger asChild>
                <Button variant="outline" size="sm"><SlidersHorizontal className="mr-2 h-4 w-4"/>Weights</Button>
              </PopoverTrigger>
              <PopoverContent className="w-80">
                <div className="space-y-3">
                  <div className="text-sm font-medium">Adjust weightings</div>
                  {(
                    [
                      ["Opportunity", "opportunity"],
                      ["Maturity", "maturity"],
                      ["Tech Fit", "techFit"],
                      ["Strategic Alignment", "strategicAlignment"],
                      ["People Readiness", "peopleReadiness"],
                    ] as const
                  ).map(([label, key]) => (
                    <div key={key} className="grid grid-cols-3 items-center gap-3">
                      <Label className="col-span-1 text-xs text-muted-foreground">{label}</Label>
                      <div className="col-span-2">
                        <Slider
                          min={0}
                          max={100}
                          step={5}
                          value={[Math.round((weights as any)[key] * 100)]}
                          onValueChange={(v) => setWeights((w) => ({ ...w, [key]: v[0] / 100 }))}
                        />
                      </div>
                    </div>
                  ))}
                  <div className="text-xs text-muted-foreground">Weights auto-normalize visually; total does not need to equal 100% for demo.</div>
                </div>
              </PopoverContent>
            </Popover>

            <Button variant="outline" size="sm" onClick={exportJson}><Download className="mr-2 h-4 w-4"/>Export JSON</Button>
          </div>
        </div>
      </div>

      {/* Content */}
      <div className="mx-auto max-w-7xl px-4 py-6">
        {view === "grid" ? (
          <GridView data={sorted} weights={weights} onScore={openScoring} />
        ) : (
          <HeatmapView data={sorted} weights={weights} onScore={openScoring} />
        )}
      </div>

      {/* Scoring Drawer */}
      <Sheet open={open} onOpenChange={setOpen}>
        <SheetContent side="right" className="w-[460px] sm:w-[520px]">
          <SheetHeader>
            <SheetTitle className="flex items-center gap-2">
              {active?.name}
              {active && (
                <Badge variant="secondary" className="ml-1">{active.domain}</Badge>
              )}
            </SheetTitle>
            <SheetDescription>
              Adjust sliders to score this capability. Changes save instantly.
            </SheetDescription>
          </SheetHeader>

          {active && (
            <div className="mt-4 space-y-6">
              <ScoreSlider label="Maturity" value={active.scores.maturity} onChange={(v)=>updateScore("maturity", v)} />
              <ScoreSlider label="Tech Fit" value={active.scores.techFit} onChange={(v)=>updateScore("techFit", v)} />
              <ScoreSlider label="Strategic Alignment" value={active.scores.strategicAlignment} onChange={(v)=>updateScore("strategicAlignment", v)} />
              <ScoreSlider label="People Readiness" value={active.scores.peopleReadiness} onChange={(v)=>updateScore("peopleReadiness", v)} />
              <ScoreSlider label="Opportunity" value={active.scores.opportunity} onChange={(v)=>updateScore("opportunity", v)} />

              <div className="rounded-2xl border p-4">
                <div className="mb-1 flex items-center gap-2 text-sm font-medium">
                  <Info className="h-4 w-4"/> AI Coach
                </div>
                <p className="text-sm text-muted-foreground whitespace-pre-line">{aiCoachTip(active.scores)}</p>
              </div>

              <div className="rounded-2xl border p-4">
                <div className="text-sm">Composite Score</div>
                <div className="text-3xl font-semibold tracking-tight">{(compositeScore(active.scores, weights) * 100).toFixed(0)}<span className="text-sm align-super">/100</span></div>
              </div>

              <SheetFooter>
                <Button onClick={()=>setOpen(false)} className="w-full">Done</Button>
              </SheetFooter>
            </div>
          )}
        </SheetContent>
      </Sheet>
    </div>
  );
}

function GridView({ data, weights, onScore }: { data: Capability[]; weights: typeof defaultWeights; onScore: (c: Capability)=>void }) {
  return (
    <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
      {data.map((c) => {
        const cs = compositeScore(c.scores, weights);
        return (
          <Card key={c.id} className={`rounded-2xl border-2 ${heatColor(cs)}`}>
            <CardHeader className="pb-2">
              <CardTitle className="text-base">{c.name}</CardTitle>
              <CardDescription className="flex items-center gap-2">
                <Badge variant="outline">{c.domain}</Badge>
                <span className="text-xs">Composite: {(cs * 100).toFixed(0)}/100</span>
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="mb-3 grid grid-cols-2 gap-3 text-sm">
                <Kpi label="Maturity" value={c.scores.maturity} />
                <Kpi label="Tech Fit" value={c.scores.techFit} />
                <Kpi label="Strat Align" value={c.scores.strategicAlignment} />
                <Kpi label="People" value={c.scores.peopleReadiness} />
                <Kpi label="Opportunity" value={c.scores.opportunity} />
              </div>
              <div className="flex items-center gap-2">
                <Button size="sm" onClick={() => onScore(c)}>Score</Button>
                <Button size="sm" variant="outline">Details</Button>
              </div>
            </CardContent>
          </Card>
        );
      })}
    </div>
  );
}

function HeatmapView({ data, weights, onScore }: { data: Capability[]; weights: typeof defaultWeights; onScore: (c: Capability)=>void }) {
  // Simple heat list by domain groups
  const byDomain = useMemo(() => {
    const map: Record<string, Capability[]> = {};
    data.forEach((c) => {
      map[c.domain] = map[c.domain] || [];
      map[c.domain].push(c);
    });
    return map;
  }, [data]);

  return (
    <div className="space-y-6">
      {Object.entries(byDomain).map(([dom, caps]) => (
        <div key={dom}>
          <div className="mb-2 text-sm font-semibold text-muted-foreground">{dom}</div>
          <div className="grid grid-cols-2 gap-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6">
            {caps.map((c) => {
              const cs = compositeScore(c.scores, weights);
              return (
                <button
                  key={c.id}
                  onClick={() => onScore(c)}
                  className={`rounded-xl border-2 px-3 py-2 text-left text-xs hover:opacity-90 ${heatColor(cs)}`}
                >
                  <div className="line-clamp-2 font-medium">{c.l2 || c.name}</div>
                  <div className="mt-1 text-[10px] text-muted-foreground">{(cs * 100).toFixed(0)}/100</div>
                </button>
              );
            })}
          </div>
        </div>
      ))}
    </div>
  );
}

function Kpi({ label, value }: { label: string; value: number }) {
  return (
    <div className="rounded-lg border p-2">
      <div className="text-[10px] text-muted-foreground">{label}</div>
      <div className="text-base font-semibold">{value}</div>
    </div>
  );
}

function ScoreSlider({ label, value, onChange }: { label: string; value: number; onChange: (v: number)=>void }) {
  return (
    <div className="space-y-2">
      <div className="flex items-center justify-between">
        <Label className="text-sm">{label}</Label>
        <Badge variant="outline">{value}</Badge>
      </div>
      <Slider min={1} max={5} step={1} value={[value]} onValueChange={(v)=>onChange(v[0])} />
      <div className="flex justify-between text-[10px] text-muted-foreground">
        <span>1 • Emerging</span>
        <span>3 • Established</span>
        <span>5 • Leading</span>
      </div>
    </div>
  );
}