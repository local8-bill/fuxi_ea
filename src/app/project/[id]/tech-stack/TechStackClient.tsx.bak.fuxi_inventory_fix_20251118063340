"use client";

import { useEffect, useState } from "react";
import {
  uploadLucidCsv,
  fetchDigitalEnterpriseStats,
} from "@/lib/api/digitalEnterprise";
import { FileUploadPanel } from "@/components/panels/FileUploadPanel";
import { WorkspaceHeader } from "@/components/layout/WorkspaceHeader";
import { MetricCard } from "@/components/ui/MetricCard";
import { Card } from "@/components/ui/Card";

interface DigitalEnterpriseStats {
  systemsFuture: number;
  integrationsFuture: number;
  domainsDetected: number;
  topSystems: any[];
}

interface Props {
  projectId: string;
}

function formatNumber(n: number | undefined | null): string {
  if (n == null || Number.isNaN(n)) return "0";
  return n.toLocaleString();
}

export function TechStackClient({ projectId }: Props) {
  const [stats, setStats] = useState<DigitalEnterpriseStats | null>(null);
  const [loading, setLoading] = useState<boolean>(true);
  const [uploading, setUploading] = useState<boolean>(false);
  const [error, setError] = useState<string | null>(null);

  async function loadStats() {
    setLoading(true);
    setError(null);
    try {
      const json = await fetchDigitalEnterpriseStats(projectId);
      setStats(json);
    } catch (err: any) {
      console.error("[TECH-STACK] failed to load DE stats", err);
      setError(err?.message ?? "Failed to load Digital Enterprise stats");
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    if (!projectId) {
      setLoading(false);
      setError("Missing project id.");
      return;
    }
    loadStats();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [projectId]);

  async function handleLucidUpload(file: File) {
    setUploading(true);
    setError(null);
    try {
      await uploadLucidCsv(projectId, file);
      await loadStats();
    } catch (err: any) {
      console.error("[TECH-STACK] Lucid upload failed", err);
      setError(err?.message ?? "Lucid upload failed");
    } finally {
      setUploading(false);
    }
  }

  const hasDE =
    !!stats &&
    ((stats.systemsFuture ?? 0) > 0 ||
      (stats.integrationsFuture ?? 0) > 0);

  // For now, artifacts = 1 if we have any DE stats; inventory/normalized apps TBD.
  const artifactCount = hasDE ? 1 : 0;
  const inventoryRows = 0;
  const normalizedApps = 0;

  return (
    <div className="px-8 py-10 max-w-6xl mx-auto">
      <WorkspaceHeader
        statusLabel="STATUS"
        title="Tech Stack Workspace"
        description="Upload inventories, diagrams, and Lucid exports to understand your applications, integrations, and dependencies."
      />

      <Card className="mb-4">
        <p className="text-[0.65rem] tracking-[0.25em] text-gray-500 mb-1 uppercase">
          INPUTS
        </p>
        <p className="text-xs text-gray-500">
          This workspace will ingest inventories, Lucid diagrams, and other
          artifacts to build a live view of your digital enterprise for project{" "}
          <span className="font-medium">{projectId}</span>.
        </p>
      </Card>

      <FileUploadPanel
        title="UPLOAD LUCID CSV"
        helper="Upload a Lucid CSV export of your architecture diagram. We'll infer systems and integrations automatically and update the Digital Enterprise metrics."
        label={uploading ? "Uploading..." : "Upload Lucid CSV"}
        onFileSelected={handleLucidUpload}
      />

      <div className="mb-8 grid grid-cols-1 sm:grid-cols-3 gap-4">
        <MetricCard
          label="ARTIFACTS"
          value={formatNumber(artifactCount)}
          description="Inventory / diagram / Lucid files in this project."
        />
        <MetricCard
          label="INVENTORY ROWS"
          value={formatNumber(inventoryRows)}
          description="Application rows ingested from spreadsheets."
        />
        <MetricCard
          label="NORMALIZED APPS"
          value={formatNumber(normalizedApps)}
          description="Systems clustered into canonical applications."
        />
      </div>

      <Card>
        <p className="text-[0.65rem] tracking-[0.25em] text-gray-500 mb-1 uppercase">
          DIGITAL ENTERPRISE PREVIEW
        </p>
        <p className="text-xs text-gray-500 mb-4">
          Parsed from your latest Lucid CSV. These stats will power the Digital
          Enterprise view.
        </p>

        {loading && (
          <div className="text-sm text-gray-500">Loading Digital Enterprise previewâ€¦</div>
        )}

        {!loading && error && (
          <div className="text-sm text-red-500">{error}</div>
        )}

        {!loading && !error && !hasDE && (
          <div className="text-sm text-gray-500">
            No Digital Enterprise data available yet. Upload a Lucid CSV to
            populate these metrics.
          </div>
        )}

        {!loading && !error && hasDE && stats && (
          <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <MetricCard
              label="SYSTEMS"
              value={formatNumber(stats.systemsFuture)}
              description="Unique labeled systems in this diagram."
            />
            <MetricCard
              label="INTEGRATIONS"
              value={formatNumber(stats.integrationsFuture)}
              description="System-to-system connections from Lucid connector lines."
            />
            <MetricCard
              label="DOMAINS DETECTED"
              value={formatNumber(stats.domainsDetected ?? 0)}
              description="Domain clustering will be introduced in a later iteration."
            />
          </div>
        )}
      </Card>
    </div>
  );
}
