"use client";

import React from "react";
import { useParams } from "next/navigation";
import { ModernizationImportPanel } from "@/features/tech-stack/ModernizationImportPanel";
import { useModernizationSummary } from "@/features/tech-stack/useModernizationSummary";

type LucidStats = {
  systems: number;
  integrations: number;
  domains: number;
};

export default function TechStackPage() {
  const { id } = useParams<{ id: string }>();
  const projectId = id ?? "unknown";

  // Existing modernization summary
  const summary = useModernizationSummary();

  // Always pass something with arrays so .length is safe
  const safeSummary = summary ?? {
    artifacts: [] as any[],
    inventoryRows: [] as any[],
    normalizedApps: [] as any[],
  };

  // Lucid stats + error state
  const [lucidStats, setLucidStats] = React.useState<LucidStats | null>(null);
  const [lucidError, setLucidError] = React.useState<string | null>(null);

  const handleUploadLucid = React.useCallback(
    async (file: File) => {
      try {
        setLucidError(null);

        const fd = new FormData();
        fd.append("file", file);
        fd.append("projectId", String(projectId));

        const res = await fetch(`/api/digital-enterprise/lucid?project=${encodeURIComponent(projectId)}`, {
          method: "POST",
          body: fd,
        });

        if (!res.ok) {
          const text = await res.text();
          console.error("Lucid upload failed", res.status, text);
          setLucidError("Lucid upload failed.");
          return;
        }

        const data = (await res.json()) as { stats?: LucidStats };

        if (data?.stats) {
          setLucidStats(data.stats);
        } else {
          setLucidError("Lucid CSV parsed, but no stats were returned.");
        }
      } catch (err) {
        console.error("Lucid upload error", err);
        setLucidError("Unexpected error while processing Lucid CSV.");
      }
    },
    [projectId],
  );

  return (
    <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
      {/* Header */}
      <section className="space-y-2">
        <p className="text-xs uppercase tracking-[0.4em] text-slate-500">
          STATUS
        </p>
        <h1 className="text-3xl font-semibold text-slate-900">
          Tech Stack Workspace
        </h1>
        <p className="text-sm text-slate-500">
          Upload inventories, diagrams, and Lucid exports to understand your
          applications, integrations, and dependencies.
        </p>
      </section>

      {/* Inputs + summary */}
      <ModernizationImportPanel
        projectId={String(projectId)}
        summary={safeSummary}
        onUploadLucid={handleUploadLucid}
      />

      {/* Digital Enterprise preview (from Lucid) */}
      {lucidStats && (
        <section className="card border border-slate-200 p-4 space-y-3">
          <div className="flex items-baseline justify-between gap-4">
            <div>
              <p className="text-xs uppercase tracking-[0.3em] text-slate-500">
                DIGITAL ENTERPRISE PREVIEW
              </p>
              <p className="text-sm text-slate-500">
                Parsed from your latest Lucid CSV. These stats will power the
                Digital Enterprise view.
              </p>
            </div>
          </div>

          <div className="grid gap-4 sm:grid-cols-3">
            <div>
              <p className="text-xs uppercase tracking-[0.2em] text-slate-500">
                SYSTEMS (FUTURE)
              </p>
              <p className="text-xl font-semibold text-slate-900">
                {lucidStats.systems}
              </p>
            </div>
            <div>
              <p className="text-xs uppercase tracking-[0.2em] text-slate-500">
                INTEGRATIONS (FUTURE)
              </p>
              <p className="text-xl font-semibold text-slate-900">
                {lucidStats.integrations}
              </p>
            </div>
            <div>
              <p className="text-xs uppercase tracking-[0.2em] text-slate-500">
                DOMAINS DETECTED
              </p>
              <p className="text-xl font-semibold text-slate-900">
                {lucidStats.domains}
              </p>
            </div>
          </div>
        </section>
      )}

      {lucidError && (
        <p className="text-xs text-red-500">
          {lucidError}
        </p>
      )}
    </div>
  );
}
