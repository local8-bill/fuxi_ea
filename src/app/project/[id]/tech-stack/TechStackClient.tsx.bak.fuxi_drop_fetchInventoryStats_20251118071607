"use client";

import { useEffect, useState } from "react";
import { WorkspaceHeader } from "@/components/layout/WorkspaceHeader";
import { FileUploadPanel } from "@/components/panels/FileUploadPanel";
import { MetricCard } from "@/components/ui/MetricCard";
import { Card } from "@/components/ui/Card";
import {
  uploadLucidCsv,
  fetchDigitalEnterpriseStats,
} from "@/lib/api/digitalEnterprise";
import {
  uploadInventorySpreadsheet,
  fetchInventoryStats,
  type InventoryStats,
} from "@/lib/api/inventory";

interface DigitalEnterpriseStats {
  systemsFuture: number;
  integrationsFuture: number;
  domainsDetected?: number;
}

interface Props {
  projectId: string;
}

function formatNumber(n: number | undefined | null): string {
  if (n == null || Number.isNaN(n)) return "0";
  return n.toLocaleString();
}

export function TechStackClient({ projectId }: Props) {
  const [artifactCount, setArtifactCount] = useState<number>(0);
  const [inventoryRows, setInventoryRows] = useState<number>(0);
  const [normalizedApps, setNormalizedApps] = useState<number>(0);

  const [invStats, setInvStats] = useState<InventoryStats | null>(null);
  const [deStats, setDeStats] = useState<DigitalEnterpriseStats | null>(null);

  const [loadingInv, setLoadingInv] = useState<boolean>(true);
  const [loadingDE, setLoadingDE] = useState<boolean>(true);
  const [uploadingInv, setUploadingInv] = useState<boolean>(false);
  const [uploadingLucid, setUploadingLucid] = useState<boolean>(false);

  const [invError, setInvError] = useState<string | null>(null);
  const [deError, setDeError] = useState<string | null>(null);

  useEffect(() => {
    let cancelled = false;

    async function loadInventory() {
      setLoadingInv(true);
      setInvError(null);

      try {
        const stats = await fetchInventoryStats(projectId);
        if (cancelled) return;

        if (stats) {
          setInvStats(stats);
          setInventoryRows(stats.rowCount);
          setNormalizedApps(stats.uniqueSystems);
          setArtifactCount((prev) =>
            stats.rowCount > 0 ? Math.max(prev, 1) : prev
          );
        } else {
          setInvStats(null);
          setInventoryRows(0);
          setNormalizedApps(0);
        }
      } catch (err: any) {
        console.error("[TECH-STACK] Error loading inventory stats", err);
        if (!cancelled) {
          setInvError("Failed to load inventory statistics.");
          setInvStats(null);
        }
      } finally {
        if (!cancelled) {
          setLoadingInv(false);
        }
      }
    }

    async function loadDE() {
      setLoadingDE(true);
      setDeError(null);

      try {
        const stats = await fetchDigitalEnterpriseStats(projectId);
        if (cancelled) return;

        if (stats) {
          setDeStats(stats);
        } else {
          setDeStats(null);
        }
      } catch (err: any) {
        console.error("[TECH-STACK] Error loading digital enterprise stats", err);
        if (!cancelled) {
          setDeError("Failed to load digital enterprise preview.");
          setDeStats(null);
        }
      } finally {
        if (!cancelled) {
          setLoadingDE(false);
        }
      }
    }

    loadInventory();
    loadDE();

    return () => {
      cancelled = true;
    };
  }, [projectId]);

  async function handleInventoryUpload(file: File) {
    setUploadingInv(true);
    setInvError(null);

    try {
      const resp = await uploadInventorySpreadsheet(projectId, file);
      const stats = resp.stats ?? {
        projectId: resp.projectId,
        rowCount: resp.rowCount,
        uniqueSystems: resp.uniqueSystems,
      };

      setInvStats(stats);
      setInventoryRows(stats.rowCount);
      setNormalizedApps(stats.uniqueSystems);
      setArtifactCount((prev) =>
        stats.rowCount > 0 ? Math.max(prev, 1) : prev
      );

      console.log("[TECH-STACK] Inventory upload success", resp);
    } catch (err: any) {
      console.error("[TECH-STACK] Inventory upload failed", err);
      setInvError(err?.message ?? "Inventory upload failed.");
    } finally {
      setUploadingInv(false);
    }
  }

  async function handleLucidUpload(file: File) {
    setUploadingLucid(true);
    setDeError(null);

    try {
      const resp = await uploadLucidCsv(projectId, file);
      console.log("[TECH-STACK] Lucid upload success", resp);
      const stats = await fetchDigitalEnterpriseStats(projectId);
      if (stats) {
        setDeStats(stats);
      }
      setArtifactCount((prev) => Math.max(prev, 1));
    } catch (err: any) {
      console.error("[TECH-STACK] Lucid upload failed", err);
      setDeError(err?.message ?? "Lucid upload failed.");
    } finally {
      setUploadingLucid(false);
    }
  }

  const hasDE =
    !!deStats &&
    ((deStats.systemsFuture ?? 0) > 0 ||
      (deStats.integrationsFuture ?? 0) > 0);

  return (
    <div className="px-8 py-10 max-w-6xl mx-auto">
      <WorkspaceHeader
        statusLabel="STATUS"
        title="Tech Stack Workspace"
        description="Upload inventories, diagrams, and Lucid exports to understand your applications, integrations, and dependencies."
      />

      {/* Inputs description */}
      <Card className="mb-4">
        <p className="text-[0.65rem] tracking-[0.25em] text-gray-500 mb-1 uppercase">
          INPUTS
        </p>
        <p className="text-xs text-gray-500">
          Upload artifacts to build a live view of your digital enterprise for project{" "}
          <span className="font-medium">{projectId}</span>.
        </p>
      </Card>

      {/* Upload panels */}
      <FileUploadPanel
        title="UPLOAD INVENTORY SPREADSHEET"
        helper="Export your technology inventory from Excel as CSV and upload it here. We'll parse systems and normalize them for comparison."
        label={uploadingInv ? "Uploading…" : "Upload Inventory CSV"}
        onFileSelected={handleInventoryUpload}
        className="mb-4"
      />

      <FileUploadPanel
        title="UPLOAD LUCID CSV"
        helper="Upload a Lucid CSV export of your architecture diagram. We'll infer systems and integrations automatically and update the Digital Enterprise metrics."
        label={uploadingLucid ? "Uploading…" : "Upload Lucid CSV"}
        onFileSelected={handleLucidUpload}
      />

      {/* Inventory / artifact metrics */}
      <div className="mb-8 grid grid-cols-1 sm:grid-cols-3 gap-4 mt-6">
        <MetricCard
          label="ARTIFACTS"
          value={formatNumber(artifactCount)}
          description="Inventory and diagram files in this project."
        />
        <MetricCard
          label="INVENTORY ROWS"
          value={formatNumber(inventoryRows)}
          description="Application rows ingested from spreadsheets."
        />
        <MetricCard
          label="NORMALIZED APPS"
          value={formatNumber(normalizedApps)}
          description="Systems clustered into canonical applications from inventory."
        />
      </div>

      {invError && (
        <div className="mb-4 text-xs text-red-500">{invError}</div>
      )}

      {/* Digital Enterprise preview */}
      <Card>
        <p className="text-[0.65rem] tracking-[0.25em] text-gray-500 mb-1 uppercase">
          DIGITAL ENTERPRISE PREVIEW
        </p>
        <p className="text-xs text-gray-500 mb-4">
          Derived from your Lucid architecture diagram. Systems and integrations
          here represent the structural view of your ecosystem.
        </p>
        {loadingDE && (
          <div className="text-sm text-gray-500">
            Loading Digital Enterprise preview…
          </div>
        )}
        {!loadingDE && deError && (
          <div className="text-sm text-red-500">{deError}</div>
        )}
        {!loadingDE && !deError && hasDE && deStats && (
          <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <MetricCard
              label="SYSTEMS"
              value={formatNumber(deStats.systemsFuture)}
              description="Unique labeled systems in this diagram."
            />
            <MetricCard
              label="INTEGRATIONS"
              value={formatNumber(deStats.integrationsFuture)}
              description="System-to-system connections from Lucid connector lines."
            />
            <MetricCard
              label="DOMAINS DETECTED"
              value={formatNumber(deStats.domainsDetected ?? 0)}
              description="Domain clustering will be introduced in a later iteration."
            />
          </div>
        )}
        {!loadingDE && !deError && !hasDE && (
          <div className="text-sm text-gray-500">
            No Digital Enterprise metrics yet. Upload a Lucid CSV to populate this
            preview.
          </div>
        )}
      </Card>
    </div>
  );
}
