import type {
  DigitalEnterpriseView,
  DigitalEnterpriseNode,
  DigitalEnterpriseEdge,
} from "@/domain/model/digitalEnterprise";

const store = new Map<string, DigitalEnterpriseView>();

export type TopSystem = {
  name: string;
  degree: number;
};

export type DigitalEnterpriseStats = {
  systemsFuture: number;
  integrationsFuture: number;
  domainsDetected: number;
  topSystems: TopSystem[];
};

export function saveLucidItemsForProject(
  projectId: string,
  view: DigitalEnterpriseView,
): void {
  store.set(projectId, view);
  const nodeCount = view.nodes?.length ?? 0;
  const edgeCount = view.edges?.length ?? 0;
  console.log(
    "[DE-STORE] saved view for project=%s nodes=%d edges=%d",
    projectId,
    nodeCount,
    edgeCount,
  );
}

export function getStatsForProject(projectId: string): DigitalEnterpriseStats {
  const view = store.get(projectId);

  if (!view) {
    console.log("[DE-STATS] no view for project=%s", projectId);
    return {
      systemsFuture: 0,
      integrationsFuture: 0,
      domainsDetected: 0,
      topSystems: [],
    };
  }

  const edges: DigitalEnterpriseEdge[] = Array.isArray(view.edges)
    ? (view.edges as DigitalEnterpriseEdge[])
    : [];

  const nodes: DigitalEnterpriseNode[] = Array.isArray(view.nodes)
    ? (view.nodes as DigitalEnterpriseNode[])
    : [];

  const degree = new Map<string, number>();

  for (const edge of edges) {
    // Be defensive about the field names coming out of Lucid parsing
    const rawFrom =
      // id-ish fields
      // @ts-expect-error – we’re defensive against multiple shapes
      edge.fromId ??
      // @ts-expect-error
      edge.sourceId ??
      // label/name-ish
      // @ts-expect-error
      edge.fromName ??
      // @ts-expect-error
      edge.sourceLabel ??
      // generic fields
      // @ts-expect-error
      edge.from ??
      // @ts-expect-error
      edge.source;

    const rawTo =
      // id-ish fields
      // @ts-expect-error
      edge.toId ??
      // @ts-expect-error
      edge.targetId ??
      // label/name-ish
      // @ts-expect-error
      edge.toName ??
      // @ts-expect-error
      edge.targetLabel ??
      // generic fields
      // @ts-expect-error
      edge.to ??
      // @ts-expect-error
      edge.target;

    if (!rawFrom || !rawTo) continue;

    const from = String(rawFrom).trim();
    const to = String(rawTo).trim();

    if (!from || !to) continue;
    if (from === to) continue;

    degree.set(from, (degree.get(from) ?? 0) + 1);
    degree.set(to, (degree.get(to) ?? 0) + 1);
  }

  const systemsFuture = degree.size;
  const integrationsFuture = edges.length;

  const topSystems: TopSystem[] = [];

  for (const [key, deg] of degree.entries()) {
    const node =
      nodes.find(
        (n: any) =>
          n.id === key ||
          n.label === key ||
          n.name === key,
      ) ?? null;

    const name =
      // @ts-expect-error – tolerate flexible node shapes
      node?.label ||
      // @ts-expect-error
      node?.name ||
      key;

    topSystems.push({
      name,
      degree: deg,
    });
  }

  topSystems.sort((a, b) => {
    if (b.degree !== a.degree) return b.degree - a.degree;
    return a.name.localeCompare(b.name);
  });

  const top10 = topSystems.slice(0, 10);

  console.log(
    "[DE-STATS] project=%s systems=%d integrations=%d topSystems=%d",
    projectId,
    systemsFuture,
    integrationsFuture,
    top10.length,
  );

  return {
    systemsFuture,
    integrationsFuture,
    domainsDetected: 0, // future: real ecosystem clustering
    topSystems: top10,
  };
}

//
// Alias added by scripts/fix-de-store-alias.sh to satisfy API import:
//   import { saveDigitalEnterpriseView } from "@/domain/services/digitalEnterpriseStore";
//
export { saveLucidItemsForProject as saveDigitalEnterpriseView };
